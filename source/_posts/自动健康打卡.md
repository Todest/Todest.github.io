---
title: 自动健康打卡
categories:
- 编程语言
- Python
tags: Python
abbrlink: '934e7461'
date: 2020-12-01 11:56:35
---
自动健康打卡(逃

建议使用Coding定时构建，强烈不推荐使用国外服务器，包括github action。
**因当天打卡系统异常造成无法打卡时，需等待打卡系统正常后自行打卡或手动触发构建计划。**

**本文档以及代码可能会不定时更新，修复和优化，部署成功的能不能在下面留言告诉一下，且留意本文章是否更新，最后更新时间可以看最上方。**
<!--more-->

# AutoReport
注意修改此部分，将`***`都进行修改，申请AK和SK教程见后文。
```py
USER_CONFIG = {
    'CHANGE_DATA': True,  # 是否更改健康打卡地址为学校
    'CHANGE_ADDR': True,  # 是否修改IP地址
    'IP_ADDR': '223.90.40.4',  # 自定义IP地址
    'API_KEY': '***',  # AK	[必改项]
    'SECRET_KEY': '***'  # SK	[必改项]
}
```
添加用户信息，账号密码为[统一认证](https://uia.hpu.edu.cn)账号密码。
如需多用户，可在`USER_LIST`里按示例添加新行。
```py
USER_LIST = {
    # '昵称': ['账号', '密码'],
    'user1': ['账号', '密码'],
}
```

上述AK以及SK需前往[百度智能云](https://console.bce.baidu.com/ai/#/ai/ocr/app/list)申请文字识别OCR API。
点击创建应用，依次填写应用名称，文字识别包名为不需要，应用归属为个人，应用描述后，点击立即创建，返回应用列表，即可得到API Key和Secret Key。


以下是完整代码，注意要按上面教程修改好方可使用。

```py
import logging
import requests
import re
import sys
import random
from time import time
from bs4 import BeautifulSoup

USER_CONFIG = {
    'CHANGE_DATA': True,  # 是否更改健康打卡地址为学校
    'CHANGE_ADDR': True,  # 是否修改IP地址
    'IP_ADDR': '223.90.40.4',  # 自定义IP地址
    'API_KEY': '***',  # 百度智能云 文字识别OCR AK
    'SECRET_KEY': '***'  # 百度智能云 文字识别OCR SK
}

USER_LIST = {
    # '昵称': ['账号', '密码'],
    'user1': ['账号', '密码'],
}

# 固定链接，不建议修改
URL_MAP = {
    'HOST': 'https://ehall.hpu.edu.cn/infoplus/form/XSMRJKSB/start',
    'START': 'https://ehall.hpu.edu.cn/infoplus/interface/start',
    'ALIVE': 'https://ehall.hpu.edu.cn/infoplus/alive',
    'CAPTCHA': 'https://uia.hpu.edu.cn/sso/apis/v2/open/captcha?date=',
    'LOGIN': 'https://uia.hpu.edu.cn/cas/login',
    'RENDER': 'https://ehall.hpu.edu.cn/infoplus/interface/render',
    'PROCESS': 'https://ehall.hpu.edu.cn/infoplus/interface/instance/[id]/progress',
    'NEXTSTEP': 'https://ehall.hpu.edu.cn/infoplus/interface/listNextStepsUsers',
    'DOACTION': 'https://ehall.hpu.edu.cn/infoplus/interface/doAction',
    'API': 'https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=[ak]&client_secret=[sk]',
    'REQUEST_URL': 'https://aip.baidubce.com/rest/2.0/ocr/v1/general_basic'
}

# 请求头，可以按需更改
headers = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) '
                  'Chrome/78.0.3904.108 Safari/537.36 QIHU 360EE'
}


class Bot:
    def __init__(self):
        logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
        self.logger = logging.getLogger('AutoReport')
        self.logger.info('程序启动中...')

        # 登录并打卡
        for user in USER_LIST:
            self.sessions = requests.session()
            self.login(user)
            self.post()
            self.sessions.close()

    def login(self, user):
        self.logger.info('%s开始登录中...' % user)

        # 登录页面
        req = self.sessions.get(URL_MAP['HOST'], headers=headers)
        req = self.sessions.get(req.url, headers=headers)
        soup = BeautifulSoup(req.content, features="html.parser")
        form = soup.find_all('input', class_='for-form')

        # 验证码获取
        captcha = URL_MAP['CAPTCHA'] + str(int(round(time() * 1000)))
        req = self.sessions.get(captcha, headers=headers)
        img = eval(req.content)['img']
        self.logger.info('验证码获取成功!')

        # 验证码识别
        api = URL_MAP['API'].replace('[ak]', USER_CONFIG['API_KEY']).replace('[sk]', USER_CONFIG['SECRET_KEY'])
        response = requests.get(api)
        access_token = response.json()['access_token']
        request_url = URL_MAP['REQUEST_URL'] + "?access_token=" + access_token
        api_headers = {'content-type': 'application/x-www-form-urlencoded'}
        response = requests.post(request_url, data={'image': img}, headers=api_headers)
        captcha = response.json()['words_result'][0]['words']
        captcha = eval(str(captcha).replace('=?', ''))
        self.logger.info('验证码识别成功!')

        # 构造表单
        token = eval(req.content)['token']
        formdata = {
            'username': USER_LIST[user][0],
            'password': USER_LIST[user][1],
            '_eventId': 'submit',
            'token': token
        }
        formdata.update({f['name']: f['value'] for f in form})
        formdata.update({'captcha': captcha})

        # 登录
        req = self.sessions.post(URL_MAP['LOGIN'], headers=headers, data=formdata)
        soup = BeautifulSoup(req.content, features='html.parser')
        errormes = soup.find('span', id='errormes')
        if errormes:
            self.logger.error(errormes['value'])
            sys.exit(0)

        # 检测登录状态
        url = self.sessions.get(URL_MAP['HOST'], headers=headers).url
        if not url == URL_MAP['HOST']:
            self.logger.error('登录失败, 未知错误!')
            sys.exit(0)
        else:
            self.logger.info('使用账号密码登录成功!')

    def post(self):
        self.logger.info('打卡进行中...')
        req = self.sessions.get(URL_MAP['HOST'], headers=headers)
        soup = BeautifulSoup(req.content, features='html.parser')

        # 构造表单
        csrf = soup.find('meta', itemscope='csrfToken')['content']
        formdata = {
            'idc': 'XSMRJKSB',
            'release': '',
            'csrfToken': csrf,
            'formData': '{"_VAR_URL":"https://ehall.hpu.edu.cn/infoplus/form/XSMRJKSB/start","_VAR_URL_Attr":"{}"}'
        }
        req = self.sessions.post(URL_MAP['START'], headers=headers, data=formdata)
        url = req.json()['entities'][0]

        # 构造表单
        stepid = int(re.findall('\d+', url)[0])
        self.logger.info('开始流程%s中...' % stepid)
        formdata = {
            'stepId': stepid,
            'instanceId': '',
            'admin': 'false',
            'rand': random.random() * 999,
            'width': '1747',
            'lang': 'zh',
            'csrfToken': csrf
        }
        headers.update({'Referer': url})
        req = self.sessions.post(URL_MAP['RENDER'], headers=headers, data=formdata)
        self.logger.info('已加载审批表!')
        form = req.json()['entities'][0]

        # 构造表单
        instanceid = form['step']['instanceId']
        formdata = {
            'stepId': stepid,
            'includingTop': 'true',
            'csrfToken': csrf,
            'lang': 'zh'
        }
        req = self.sessions.post(URL_MAP['PROCESS'].replace('[id]', instanceid), headers=headers, data=formdata)
        self.logger.info('审批表处理中...')
        timestamp = req.json()['entities'][0]['remarks'][0]['assignTime']
        boundfields = ','.join(list(form['data'].keys()))

        # 构造表单
        postdata = form['data']
        if USER_CONFIG['CHANGE_DATA']:
            fixdata = {
                'fieldTXcs': '410800',
                'fieldTXcs_Name': '焦作市',
                'fieldTXdq': '410811',
                'fieldTXdq_Name': '山阳区',
                'fieldTXjtwz': '河南理工大学'
            }
            postdata.update(fixdata)
        if USER_CONFIG['CHANGE_ADDR']:
            postdata.update({'_VAR_ADDR': USER_CONFIG['IP_ADDR']})
        formdata = {
            'stepId': stepid,
            'actionId': 1,
            'formData': str(postdata),
            'timestamp': timestamp,
            'rand': random.random() * 999,
            'boundFields': boundfields,
            'csrfToken': csrf,
            'lang': 'zh'
        }
        req = self.sessions.post(URL_MAP['NEXTSTEP'], headers=headers, data=formdata)
        if req.json()['ecode'] == 'SUCCEED':
            self.logger.info('健康打卡准备阶段, 成功!')

        # 构造表单
        formdata = {
            'actionId': 1,
            'formData': str(form['data']),
            'remark': '',
            'rand': random.random() * 999,
            'nextUsers': '{}',
            'stepId': stepid,
            'timestamp': timestamp,
            'boundFields': boundfields,
            'csrfToken': csrf,
            'lang': 'zh'
        }
        req = self.sessions.post(URL_MAP['DOACTION'], headers=headers, data=formdata)
        if req.json()['ecode'] == 'SUCCEED':
            self.logger.info('健康打卡填报阶段, 成功!')


if __name__ == '__main__':
    bot = Bot()

```

# Coding

1. 登录[Coding](https://e.coding.net/login)， 进入团队，切换到项目（左边栏点击'项目'），创建项目，选择DevOps项目。
2. 切换到代码仓库，新建代码仓库，勾选启用READEME.md文件初始化项目，取消启用代码扫描，点击确认。
![](https://cdn.file.todest.cn/blog/pic/20201205164547.png)
3. 新建文件AutoReport.py，将修改好的完整代码粘贴进去，点击提交并直接确认。
![](https://cdn.file.todest.cn/blog/pic/20201205164816.png)
4. 点击上方浏览返回文件根目录，再次创建文件Jenkinsfile，粘贴下面代码并提交。
```yml
pipeline {
  agent {
    any {
      reuseNode true
    }

  }
  stages {
    stage('检出') {
      steps {
        checkout([
          $class: 'GitSCM',
          branches: [[name: env.GIT_BUILD_REF]],
          userRemoteConfigs: [[
            url: env.GIT_REPO_URL,
            credentialsId: env.CREDENTIALS_ID
          ]]])
        }
      }
      stage('安装依赖') {
        steps {
          sh '''pip3 install --upgrade pip
pip3 install setuptools
pip3 install requests
pip3 install bs4'''
        }
      }
      stage('运行') {
        steps {
          sh 'python3 AutoReport.py'
        }
      }
    }
  }
```
5. 切换到持续集成->构建计划，创建构建计划，翻到最下面选择自定义构建过程，代码仓库选择此代码仓库，配置来源勾选上使用代码库中的Jenkinsfile，点击确认。
![](https://cdn.file.todest.cn/blog/pic/20201205165857.png)
6. 保存并构建，确认，立即构建，等待构建成功。
![](https://cdn.file.todest.cn/blog/pic/20201205170328.png)
7. 点击右上角的设置修改构建计划的配置，切换到触发规则，添加定时触发，设置好触发的时期时间点击确认。
![](https://cdn.file.todest.cn/blog/pic/20201205170919.png)
8. 如果到了这里还没有出现错误的话，那么就基本没问题了，可以在项目概览查看每次定时触发情况。
![](https://cdn.file.todest.cn/blog/pic/20201205171438.png)
也可以点击任务ID查看执行日志。
![](https://cdn.file.todest.cn/blog/pic/20201205171840.png)
最后，也可以前往[学校官网](https://ehall.hpu.edu.cn/taskcenter/workflow/done)查看打卡情况。

